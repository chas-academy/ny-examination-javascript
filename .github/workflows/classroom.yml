name: Autograding Tests
'on':
  - push
  - repository_dispatch

permissions:
  checks: write
  actions: read
  contents: read
  pull-requests: write

jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Installera beroenden
      run: npm install

    # --- NYTT STEG: HÃ„MTA ID FÃ–R ATT VISA I RAPPORTEN ---
    - name: HÃ¤mta Student ID frÃ¥n filen
      id: get-id
      run: |
        # Vi skapar en tillfÃ¤llig JS-fil som bara skriver ut ID:t till konsolen
        echo "try { require('./src/student-id.js'); if (typeof STUDENT_ID !== 'undefined') { console.log(STUDENT_ID); } else { console.log('HITTADES EJ'); } } catch (e) { console.log('FIL SAKNAS'); }" > temp_print_id.js
        
        # KÃ¶r filen och spara outputen i en variabel
        EXTRACTED_ID=$(node temp_print_id.js)
        
        # Spara variabeln sÃ¥ att nÃ¤sta steg kan se den
        echo "STUDENT_ID=$EXTRACTED_ID" >> $GITHUB_ENV
        
        # StÃ¤da upp
        rm temp_print_id.js

    # --- TESTERNA ---

    - name: '1. Setup & ID Kontroll (Obligatorisk)'
      id: id-check
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: '1. Setup & ID Kontroll (Obligatorisk)'
        setup-command: ''
        command: npx jest -t '1. Setup & ID Kontroll'
        timeout: 10
        max-score: 0

    - name: 'Validering: Tomma fÃ¤lt (10p)'
      if: success() || failure()
      id: val-empty
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: 'Validering: Tomma fÃ¤lt (10p)'
        command: npx jest -t 'Should NOT add transaction if inputs are empty'
        timeout: 10
        max-score: 10
      continue-on-error: true

    - name: 'Validering: Felaktiga tal (10p)'
      if: success() || failure()
      id: val-numbers
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: 'Validering: Felaktiga tal (10p)'
        command: npx jest -t 'Should handle invalid numbers gracefully'
        timeout: 10
        max-score: 10
      continue-on-error: true

    - name: 'Inkomst: LÃ¤gg till i listan (10p)'
      if: success() || failure()
      id: income-add
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: 'Inkomst: LÃ¤gg till i listan (10p)'
        command: npx jest -t 'Should add an item to the income list'
        timeout: 10
        max-score: 10
      continue-on-error: true

    - name: 'Utgift: LÃ¤gg till i listan (10p)'
      if: success() || failure()
      id: expense-add
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: 'Utgift: LÃ¤gg till i listan (10p)'
        command: npx jest -t 'Should add an item to the expense list'
        timeout: 10
        max-score: 10
      continue-on-error: true

    - name: 'Format: RÃ¤tt textformat (10p)'
      if: success() || failure()
      id: format-check
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: 'Format: RÃ¤tt textformat (10p)'
        command: npx jest -t 'Should format the list item text correctly'
        timeout: 10
        max-score: 10
      continue-on-error: true

    - name: 'Inkomst: Uppdatera saldo (10p)'
      if: success() || failure()
      id: income-balance
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: 'Inkomst: Uppdatera saldo (10p)'
        command: npx jest -t 'Should increase balance when income is added'
        timeout: 10
        max-score: 10
      continue-on-error: true

    - name: 'Utgift: Uppdatera saldo (10p)'
      if: success() || failure()
      id: expense-balance
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: 'Utgift: Uppdatera saldo (10p)'
        command: npx jest -t 'Should decrease balance when expense is added'
        timeout: 10
        max-score: 10
      continue-on-error: true

    - name: 'UX: TÃ¶m fÃ¤lt efter kÃ¶p (10p)'
      if: success() || failure()
      id: ux-clear
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: 'UX: TÃ¶m fÃ¤lt efter kÃ¶p (10p)'
        command: npx jest -t 'Should clear input fields after adding transaction'
        timeout: 10
        max-score: 10
      continue-on-error: true

    - name: 'InlÃ¤mning: Videoprov (20p)'
      if: success() || failure()
      id: video-check
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: 'InlÃ¤mning: Videoprov (20p)'
        command: npx jest -t 'Should contain a video file named'
        timeout: 10
        max-score: 20
      continue-on-error: true

    # --- RAPPORTERING ---

    - name: Autograding Reporter
      uses: classroom-resources/autograding-grading-reporter@v1
      if: always()
      env:
        ID-CHECK_RESULTS: "${{ steps.id-check.outputs.result }}"
        VAL-EMPTY_RESULTS: "${{ steps.val-empty.outputs.result }}"
        VAL-NUMBERS_RESULTS: "${{ steps.val-numbers.outputs.result }}"
        INCOME-ADD_RESULTS: "${{ steps.income-add.outputs.result }}"
        EXPENSE-ADD_RESULTS: "${{ steps.expense-add.outputs.result }}"
        FORMAT-CHECK_RESULTS: "${{ steps.format-check.outputs.result }}"
        INCOME-BALANCE_RESULTS: "${{ steps.income-balance.outputs.result }}"
        EXPENSE-BALANCE_RESULTS: "${{ steps.expense-balance.outputs.result }}"
        UX-CLEAR_RESULTS: "${{ steps.ux-clear.outputs.result }}"
        VIDEO-CHECK_RESULTS: "${{ steps.video-check.outputs.result }}"
      with:
        runners: id-check,val-empty,val-numbers,income-add,expense-add,format-check,income-balance,expense-balance,ux-clear,video-check

    # --- SKAPA KOMMENTAR PÃ… PR ---
    - name: Skapa kommentar med resultat
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const totalPoints = 100;
          let currentPoints = 0;
          
          // HÃ¤mta info om studenten
          const studentUser = context.actor; // GitHub-anvÃ¤ndarnamnet
          const studentID = process.env.STUDENT_ID || 'Kunde inte lÃ¤sas';
          
          const getStatus = (outcome, points) => {
            if (outcome === 'success') {
              currentPoints += points;
              return 'âœ…';
            }
            return 'âŒ';
          };
          
          const idCheck = '${{ steps.id-check.outcome }}';
          const valEmpty = getStatus('${{ steps.val-empty.outcome }}', 10);
          const valNumbers = getStatus('${{ steps.val-numbers.outcome }}', 10);
          const incAdd = getStatus('${{ steps.income-add.outcome }}', 10);
          const expAdd = getStatus('${{ steps.expense-add.outcome }}', 10);
          const format = getStatus('${{ steps.format-check.outcome }}', 10);
          const incBal = getStatus('${{ steps.income-balance.outcome }}', 10);
          const expBal = getStatus('${{ steps.expense-balance.outcome }}', 10);
          const ux = getStatus('${{ steps.ux-clear.outcome }}', 10);
          
          let videoStatus = 'âŒ (SAKNAS)';
          if ('${{ steps.video-check.outcome }}' === 'success') {
             currentPoints += 20;
             videoStatus = 'âœ… (20p)';
          }

          let body = `## ðŸ¤– RÃ¤ttningsroboten har talat!\n\n`;
          
          // HÃ¤r lÃ¤gger vi in studentens info i toppen av tabellen
          body += `ðŸ‘¤ **Student:** @${studentUser}\n`;
          body += `ðŸ†” **AnsÃ¶knings-ID:** \`${studentID}\`\n\n`;
          
          if (idCheck !== 'success') {
             body += `### â›” STOPP! ID-kontrollen misslyckades.\n`;
             body += `Du har inte angett ett giltigt ID i \`src/student-id.js\` eller sÃ¥ saknas 'npm install'. Inga andra tester kunde kÃ¶ras.`;
          } else {
             body += `### ðŸ† Totalt resultat: ${currentPoints} / ${totalPoints} poÃ¤ng\n\n`;
             body += `| Uppgift | Status | VÃ¤rde |\n| :--- | :---: | :---: |\n`;
             body += `| **1. Setup & ID** | âœ… | **GK** |\n`;
             body += `| Validering: Tomma fÃ¤lt | ${valEmpty} | 10p |\n`;
             body += `| Validering: Felaktiga tal | ${valNumbers} | 10p |\n`;
             body += `| Inkomst: LÃ¤gg till | ${incAdd} | 10p |\n`;
             body += `| Utgift: LÃ¤gg till | ${expAdd} | 10p |\n`;
             body += `| Format: Textformat | ${format} | 10p |\n`;
             body += `| Inkomst: Saldo | ${incBal} | 10p |\n`;
             body += `| Utgift: Saldo | ${expBal} | 10p |\n`;
             body += `| UX: TÃ¶m fÃ¤lt | ${ux} | 10p |\n`;
             body += `| **VIDEOINLÃ„MNING** | ${videoStatus} | **20p** |\n`;
          }

          const prs = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            head: context.sha
          });

          if (prs.data.length > 0) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prs.data[0].number,
              body: body
            });
          }
name: "Grading Feedback"
description: "Generates feedback table based on inputs"
inputs:
  steps-context:
    description: "JSON string of steps context"
    required: true
  grading-config:
    description: "JSON string of grading config"
    required: true
runs:
  using: "composite"
  steps:
    - name: Skapa/Uppdatera Feedback
      uses: actions/github-script@v7
      env:
        STEPS_CONTEXT: ${{ inputs.steps-context }}
        GRADING_CONFIG: ${{ inputs.grading-config }}
        STUDENT_ID: ${{ env.STUDENT_ID }}
      with:
        script: |
          const steps = JSON.parse(process.env.STEPS_CONTEXT);
          const githubUser = context.actor;

          // LÃ¤s config frÃ¥n input
          let tests = [];
          try {
             tests = JSON.parse(process.env.GRADING_CONFIG);
          } catch (e) { console.log("Config Error: " + e.message); }

          let totalScore = 0;
          let maxScore = 0;
          let rows = [];
          let requiredTestFailed = false;

          for (const test of tests) {
            const testId = test.id;
            let rawResult = "";

            // --- SMART SÃ–KNING ---
            // A. Direkt objekt
            if (steps[testId] && steps[testId].outputs && steps[testId].outputs.result) {
               rawResult = steps[testId].outputs.result;
            } 
            // B. Direkt strÃ¤ng (ibland skickar composite actions rena strÃ¤ngar)
            else if (steps[testId] && typeof steps[testId] === 'string') {
               rawResult = steps[testId];
            }
            // C. Nestlat inuti outputs frÃ¥n ett annat steg
            else {
               for (const stepKey in steps) {
                  if (steps[stepKey].outputs && steps[stepKey].outputs[testId]) {
                     rawResult = steps[stepKey].outputs[testId];
                     break;
                  }
               }
            }
            // ---------------------

            let passed = false;
            if (rawResult) {
              try {
                const decoded = Buffer.from(rawResult, 'base64').toString('utf-8');
                const json = JSON.parse(decoded);
                if (json.status === 'pass' || json.status === 'success') passed = true;
              } catch (e) {
                if (rawResult === 'success' || rawResult === 'pass') passed = true;
              }
            }

            if (test.required && !passed) requiredTestFailed = true;

            const icon = passed ? 'âœ…' : 'âŒ';
            const score = passed ? test.points : 0;
            
            // RÃ¤kna poÃ¤ng (om inte ett obligatoriskt test har misslyckats)
            if (!requiredTestFailed) {
                totalScore += score;
            }
            maxScore += test.points;
            
            rows.push(`| ${icon} | ${test.name} | ${score} / ${test.points} |`);
          }

          // Bygg kommentaren
          const studentId = process.env.STUDENT_ID || "Ej hittat";
          let commentBody = "";
          const botSignature = "";

          if (requiredTestFailed) {
            commentBody = `
            ## âš ï¸ Obligatoriskt moment misslyckades
            **Student:** @${githubUser}
            
            Vi kunde inte rÃ¤tta hela uppgiften eftersom ett kritiskt steg (t.ex. ID-kontroll eller kompilering) misslyckades.
            VÃ¤nligen kontrollera loggarna under "Actions".
            `;
          } else {
            const tableHeader = `| Status | Test | PoÃ¤ng |\n| :---: | :--- | :---: |`;
            commentBody = `
            ## ðŸ¤– Automatisk RÃ¤ttning
            **Student:** @${githubUser}
            **Student ID:** ${studentId}
            **Totalt:** ${totalScore} / ${maxScore} poÃ¤ng
            
            ${tableHeader}
            ${rows.join('\n')}
            `;
          }
          commentBody += `\n\n${botSignature}`;

          // Posta kommentaren
          try {
            const prs = await github.rest.pulls.list({ owner: context.repo.owner, repo: context.repo.repo, state: 'open' });
            if (prs.data.length > 0) {
              const prNumber = prs.data[0].number;
              const comments = await github.rest.issues.listComments({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber });
              const botComment = comments.data.find(c => c.body.includes(botSignature));
              
              if (botComment) {
                await github.rest.issues.updateComment({ owner: context.repo.owner, repo: context.repo.repo, comment_id: botComment.id, body: commentBody });
              } else {
                await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body: commentBody });
              }
            }
          } catch (e) { console.log("Error commenting: " + e.message); }

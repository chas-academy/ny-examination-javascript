name: "Grading Feedback"
description: "Posts feedback table to PR"
runs:
  using: "composite"
  steps:
    - name: Post Comment
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          let body = "";
          const runNumber = context.runNumber;
          const now = new Date().toLocaleString('sv-SE', { 
            timeZone: 'Europe/Stockholm',
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });

          // HÃ¤mta status
          const isSubmitted = process.env.STUDENT_SUBMITTED === 'true';
          const studentId = process.env.STUDENT_ID || "OkÃ¤nd";

          // --- 1. KOLLA OM OBLIGATORISKA DELAR MISSLYCKADES ---
          let hasFailedRequired = false;
          if (fs.existsSync('grading-status.json')) {
             try {
               const statusData = JSON.parse(fs.readFileSync('grading-status.json', 'utf8'));
               hasFailedRequired = statusData.failedRequired;
             } catch(e) {
               console.log("Kunde inte lÃ¤sa statusfilen:", e);
             }
          }

          // --- 2. BYGG INNEHÃ…LLET ---
          if (fs.existsSync('grading-results.json')) {
            const results = JSON.parse(fs.readFileSync('grading-results.json', 'utf8'));
            const totalPoints = results.reduce((sum, r) => sum + r.score, 0);
            const maxPoints = results.reduce((sum, r) => sum + r.points, 0);

            const rows = results.map(r => 
              `| ${r.passed ? 'âœ…' : 'âŒ'} | ${r.name} | ${r.score} / ${r.points} |`
            ).join('\n');

            // --- BESTÃ„M RUBRIK OCH TEXT ---
            let headerEmoji = "ðŸš§";
            let headerText = "PRELIMINÃ„R TESTKÃ–RNING";
            let statusMsg = "";

            if (!isSubmitted) {
                // FALL A: Utkast
                headerEmoji = "ðŸš§";
                headerText = "PRELIMINÃ„R TESTKÃ–RNING";
                statusMsg = `**Obs:** Detta Ã¤r bara en testkÃ¶rning. NÃ¤r du kÃ¤nner dig helt klar, Ã¤ndra \`"submitted": false\` till \`true\` i \`student.json\`.`;
            
            } else if (isSubmitted && hasFailedRequired) {
                // FALL B: InlÃ¤mnad men SAKNAR DELAR
                headerEmoji = "âŒ"; // RÃ¶tt kryss Ã¤ven i rubriken
                headerText = "INLÃ„MNING SAKNAR OBLIGATORISKA DELAR";
                statusMsg = `**VARNING:** Du har markerat provet som klart, men testerna visar att du missat **obligatoriska moment**. InlÃ¤mningen Ã¤r **inte godkÃ¤nd** fÃ¶rrÃ¤n detta Ã¤r Ã¥tgÃ¤rdat.`;
            
            } else {
                // FALL C: InlÃ¤mnad och OK
                headerEmoji = "ðŸŽ‰";
                headerText = "INLÃ„MNING MOTTAGEN";
                statusMsg = `**Snyggt!** Du har markerat uppgiften som klar och alla obligatoriska tester ser grÃ¶na ut. LÃ¤rarna kommer nu att rÃ¤tta din kod.`;
            }

            body = `
            ## ${headerEmoji} ${headerText}
            **Student:** ${studentId}
            **Status:** ${isSubmitted ? 'âœ… Klar fÃ¶r rÃ¤ttning' : 'âœï¸ Utkast (Arbete pÃ¥gÃ¥r)'}
            **Resultat:** ${totalPoints} / ${maxPoints} poÃ¤ng
            
            ${statusMsg}
            
            | Status | Uppgift | PoÃ¤ng |
            | :---: | :--- | :---: |
            ${rows}
            
            *(KÃ¶rdes: ${now} - FÃ¶rsÃ¶k #${runNumber})*
            `;

          } else {
            console.log("Ingen resultatsfil hittades.");
            body = `## âš ï¸ Automatisk RÃ¤ttning Misslyckades \nBotten kunde inte lÃ¤sa resultaten. Kontrollera dina filer.`;
          }

          // --- 3. POSTA KOMMENTAR ---
          try {
            const prs = await github.rest.pulls.list({ 
              owner: context.repo.owner, 
              repo: context.repo.repo, 
              state: 'open' 
            });

            if (prs.data.length > 0) {
              const prNumber = prs.data[0].number;
              
              const comments = await github.rest.issues.listComments({ 
                owner: context.repo.owner, 
                repo: context.repo.repo, 
                issue_number: prNumber 
              });
              
              // Vi letar efter gamla kommentarer oavsett vilken rubrik de hade
              const botComment = comments.data.find(c => 
                c.body.includes('Automatisk RÃ¤ttning') || 
                c.body.includes('INLÃ„MNING') || 
                c.body.includes('PRELIMINÃ„R')
              );

              if (botComment) {
                await github.rest.issues.updateComment({ 
                  owner: context.repo.owner, 
                  repo: context.repo.repo, 
                  comment_id: botComment.id, 
                  body: body 
                });
                console.log("Uppdaterade kommentar.");
              } else {
                await github.rest.issues.createComment({ 
                  owner: context.repo.owner, 
                  repo: context.repo.repo, 
                  issue_number: prNumber, 
                  body: body 
                });
                console.log("Skapade ny kommentar.");
              }
            } else {
              console.log("Ingen Ã¶ppen PR hittades.");
            }
          } catch (e) {
            console.log("Kunde inte posta kommentar: " + e.message);
          }
          // --- 3. SÃ„TT WORKFLOW STATUS ---
          if (!isSubmitted) {
            // UTKAST -> RÃ–TT KRYSS
            console.log("ðŸš§ InlÃ¤mning Ã¤r ett utkast.");
            core.setFailed("InlÃ¤mningen Ã¤r ett utkast. Ã„ndra 'submitted' till true nÃ¤r du Ã¤r klar.");

          } else if (isSubmitted && hasFailedRequired) {
            // INLÃ„MNAD MEN TRASIG -> RÃ–TT KRYSS
            console.log("âŒ InlÃ¤mnad men missade obligatoriska tester.");
            core.setFailed("InlÃ¤mningen saknar obligatoriska moment. Ã…tgÃ¤rda felen och pusha igen.");

          } else {
            // INLÃ„MNAD OCH HEL -> GRÃ–N BOCK
            console.log("âœ… InlÃ¤mning klar och giltig.");
            // Exit 0 (Success)
          }

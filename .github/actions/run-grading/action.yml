name: "Run Grading"
description: "Runs tests defined in autograding.json"
runs:
  using: "composite"
  steps:
    - name: Run Tests & Report
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const cp = require('child_process');

          // L√§s config
          const config = JSON.parse(fs.readFileSync('.github/classroom/autograding.json', 'utf8'));

          let results = [];
          let totalPoints = 0;
          let maxPoints = 0;
          let failedRequired = false;

          console.log("\nüöÄ Startar r√§ttning av tester...\n");

          for (const test of config.tests) {
            maxPoints += test.points;
            let passed = false;
            
            try {
              console.log(`üèÉ K√∂r: ${test.name}`);
              // K√∂r testet med timeout
              cp.execSync(test.run, { timeout: (test.timeout || 1) * 60000, stdio: 'pipe' });
              
              passed = true;
              totalPoints += test.points;
              console.log(`‚úÖ GODK√ÑND (+${test.points}p)`);
            } catch (e) {
              console.log(`‚ùå EJ GODK√ÑND`);
              if (test.required) {
                 console.log(`   ‚ö†Ô∏è Detta var ett obligatoriskt test!`);
                 failedRequired = true;
              }
            }
            
            // Spara data f√∂r feedback-steget
            results.push({
              name: test.name,
              points: test.points,
              score: passed ? test.points : 0,
              passed: passed
            });
          }

          // --- RAPPORTERA TILL GITHUB CLASSROOM ---
          const text = `Points ${totalPoints}/${maxPoints}`;
          const summary = JSON.stringify({ totalPoints, maxPoints });

          core.notice(text, { title: "Autograding complete" });
          core.notice(summary, { title: "Autograding report" });

          console.log(`\n-------------------------`);
          console.log(text);
          console.log(`-------------------------\n`);

          // Spara resultaten till fil s√• n√§sta action kan l√§sa dem
          fs.writeFileSync('grading-results.json', JSON.stringify(results));

          fs.writeFileSync('grading-status.json', JSON.stringify({ failedRequired: failedRequired }));
